<!-- Views/AdminWindow.xaml -->
<Window
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:av="http://schemas.microsoft.com/expression/blend/2008" xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" mc:Ignorable="av" x:Class="RailwayInformationDesk.Views.AdminWindow"
        Title="Администрирование" Height="750" Width="1100"
        WindowStartupLocation="CenterScreen">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <TextBox x:Name="SearchBox"
                 materialDesign:HintAssist.Hint="Поиск по таблице..."
                 Style="{StaticResource MaterialDesignTextBox}"
                 Margin="10"
                 TextChanged="SearchBox_TextChanged"/>

        <TabControl x:Name="MainTabControl" Grid.Row="2" Margin="10">
            <!-- Станции -->
            <TabItem Header="Станции">
                <DataGrid x:Name="StationsGrid"
                          AutoGenerateColumns="False"
                          CanUserAddRows="True"
                          CanUserDeleteRows="True"
                          PreviewKeyDown="DataGrid_PreviewKeyDown"
                          ItemsSource="{Binding Stations}">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="ID" Binding="{Binding Id}" IsReadOnly="True"/>
                        <DataGridTextColumn Header="Название" Binding="{Binding Name}" Width="*"/>
                        <DataGridTextColumn Header="Город" Binding="{Binding City}" Width="*"/>
                        <DataGridTextColumn Header="Регион" Binding="{Binding Region}" Width="*"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>

            <!-- Маршруты -->
            <TabItem Header="Маршруты">
                <DataGrid x:Name="RoutesGrid"
                          AutoGenerateColumns="False"
                          CanUserAddRows="True"
                          CanUserDeleteRows="True"
                          PreviewKeyDown="DataGrid_PreviewKeyDown"
                          ItemsSource="{Binding Routes}">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="ID" Binding="{Binding Id}" IsReadOnly="True"/>
                        <DataGridTextColumn Header="Название" Binding="{Binding Name}" Width="*"/>
                        <DataGridTemplateColumn Header="Откуда" Width="*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding DepartureStationId, ConverterParameter=Station, Converter={StaticResource IdToNameConverter}}" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                            <DataGridTemplateColumn.CellEditingTemplate>
                                <DataTemplate>
                                    <ComboBox ItemsSource="{Binding DataContext.Stations, RelativeSource={RelativeSource AncestorType={x:Type Window}}}"
                                              DisplayMemberPath="Name"
                                              SelectedValuePath="Id"
                                              SelectedValue="{Binding DepartureStationId, UpdateSourceTrigger=PropertyChanged}"
                                              Style="{StaticResource MaterialDesignComboBox}"
                                              SelectionChanged="DepartureOrArrivalStation_SelectionChanged"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellEditingTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTemplateColumn Header="Куда" Width="*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding ArrivalStationId, ConverterParameter=Station, Converter={StaticResource IdToNameConverter}}" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                            <DataGridTemplateColumn.CellEditingTemplate>
                                <DataTemplate>
                                    <ComboBox ItemsSource="{Binding DataContext.Stations, RelativeSource={RelativeSource AncestorType={x:Type Window}}}"
                                              DisplayMemberPath="Name"
                                              SelectedValuePath="Id"
                                              SelectedValue="{Binding ArrivalStationId, UpdateSourceTrigger=PropertyChanged}"
                                              Style="{StaticResource MaterialDesignComboBox}"
                                              SelectionChanged="DepartureOrArrivalStation_SelectionChanged"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellEditingTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>

            <!-- Типы поездов -->
            <TabItem Header="Типы поездов">
                <DataGrid x:Name="TrainTypesGrid"
                          AutoGenerateColumns="False"
                          CanUserAddRows="True"
                          CanUserDeleteRows="True"
                          PreviewKeyDown="DataGrid_PreviewKeyDown"
                          ItemsSource="{Binding TrainTypes}">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="ID" Binding="{Binding Id}" IsReadOnly="True"/>
                        <DataGridTextColumn Header="Название" Binding="{Binding Name}" Width="*"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>

            <!-- Расписание (ранее "Шаблоны расписаний") -->
            <TabItem Header="Расписание">
                <DataGrid x:Name="TemplatesGrid"
                          AutoGenerateColumns="False"
                          CanUserAddRows="True"
                          CanUserDeleteRows="True"
                          PreviewKeyDown="DataGrid_PreviewKeyDown"
                          MouseDoubleClick="TemplatesGrid_MouseDoubleClick"
                          ItemsSource="{Binding Templates}">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="ID" Binding="{Binding Id}" IsReadOnly="True"/>
                        <DataGridTemplateColumn Header="Маршрут" Width="2*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding RouteId, ConverterParameter=Route, Converter={StaticResource IdToNameConverter}}" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                            <DataGridTemplateColumn.CellEditingTemplate>
                                <DataTemplate>
                                    <ComboBox ItemsSource="{Binding DataContext.Routes, RelativeSource={RelativeSource AncestorType={x:Type Window}}}"
                                              DisplayMemberPath="Name"
                                              SelectedValuePath="Id"
                                              SelectedValue="{Binding RouteId, UpdateSourceTrigger=PropertyChanged}"
                                              Style="{StaticResource MaterialDesignComboBox}"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellEditingTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTemplateColumn Header="Тип поезда" Width="*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding TrainTypeId, ConverterParameter=TrainType, Converter={StaticResource IdToNameConverter}}" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                            <DataGridTemplateColumn.CellEditingTemplate>
                                <DataTemplate>
                                    <ComboBox ItemsSource="{Binding DataContext.TrainTypes, RelativeSource={RelativeSource AncestorType={x:Type Window}}}"
                                              DisplayMemberPath="Name"
                                              SelectedValuePath="Id"
                                              SelectedValue="{Binding TrainTypeId, UpdateSourceTrigger=PropertyChanged}"
                                              Style="{StaticResource MaterialDesignComboBox}"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellEditingTemplate>
                        </DataGridTemplateColumn>
                        <DataGridCheckBoxColumn Header="Активен" Binding="{Binding IsActive}" Width="Auto"/>
                        <DataGridTextColumn Header="Дни недели (напр. 1010100)" Binding="{Binding DaysOfWeek}" Width="*"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>

            <!-- Экземпляры рейсов -->
            <TabItem Header="Экземпляры рейсов">
                <DataGrid x:Name="TripInstancesGrid"
                          AutoGenerateColumns="False"
                          CanUserAddRows="True"
                          CanUserDeleteRows="True"
                          PreviewKeyDown="DataGrid_PreviewKeyDown"
                          ItemsSource="{Binding TripInstances}">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="ID" Binding="{Binding Id}" IsReadOnly="True"/>
                        <DataGridTemplateColumn Header="Шаблон" Width="2*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding TemplateId, ConverterParameter=Template, Converter={StaticResource IdToNameConverter}}" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                            <DataGridTemplateColumn.CellEditingTemplate>
                                <DataTemplate>
                                    <ComboBox ItemsSource="{Binding DataContext.Templates, RelativeSource={RelativeSource AncestorType={x:Type Window}}}"
                                              DisplayMemberPath="Route.Name"
                                              SelectedValuePath="Id"
                                              SelectedValue="{Binding TemplateId, UpdateSourceTrigger=PropertyChanged}"
                                              Style="{StaticResource MaterialDesignComboBox}"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellEditingTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTextColumn Header="Дата" Binding="{Binding TripDate}" Width="*"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>

            <!-- Пользователи -->
            <TabItem Header="Пользователи">
                <DataGrid x:Name="UsersGrid"
                          AutoGenerateColumns="False"
                          CanUserAddRows="True"
                          CanUserDeleteRows="True"
                          PreviewKeyDown="DataGrid_PreviewKeyDown"
                          ItemsSource="{Binding Users}"
                          AddingNewItem="UsersGrid_AddingNewItem">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="ID" Binding="{Binding Id}" IsReadOnly="True"/>
                        <DataGridTextColumn Header="Логин" Binding="{Binding Login}" Width="0.5*"/>
                        <DataGridTextColumn Header="ФИО" Binding="{Binding FullName}" Width="1.5*"/>
                        <DataGridTextColumn Header="Пароль" Binding="{Binding PasswordHash}" Width="*"/>
                        <DataGridTemplateColumn Header="Роль" Width="*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Role}" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                            <DataGridTemplateColumn.CellEditingTemplate>
                                <DataTemplate>
                                    <ComboBox ItemsSource="{Binding DataContext.Roles, RelativeSource={RelativeSource AncestorType={x:Type Window}}}"
                                              SelectedItem="{Binding Role, UpdateSourceTrigger=PropertyChanged}"
                                              Style="{StaticResource MaterialDesignComboBox}"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellEditingTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTemplateColumn Header="Станция" Width="2*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding StationId, ConverterParameter=Station, Converter={StaticResource IdToNameConverter}}" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                            <DataGridTemplateColumn.CellEditingTemplate>
                                <DataTemplate>
                                    <ComboBox ItemsSource="{Binding DataContext.Stations, RelativeSource={RelativeSource AncestorType={x:Type Window}}}"
                                              DisplayMemberPath="Name"
                                              SelectedValuePath="Id"
                                              SelectedValue="{Binding StationId, UpdateSourceTrigger=PropertyChanged}"
                                              Style="{StaticResource MaterialDesignComboBox}"
                                              IsEnabled="{Binding Role, Converter={StaticResource RoleToStationEnabledConverter}}"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellEditingTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
        </TabControl>

        <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Right" Margin="10">
            <Button Content="Сохранить" Click="SaveButton_Click" Style="{StaticResource MaterialDesignRaisedButton}"/>
        
        <Button Content="Выход"
            Click="ExitButton_Click"
            Style="{StaticResource MaterialDesignRaisedButton}"
            MinWidth="50" Margin="10 0"/>
        </StackPanel>
    </Grid>
</Window>