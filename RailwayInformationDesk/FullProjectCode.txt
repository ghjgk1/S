


========== FILE: .\RailwayInformationDesk\Data\RailwayInformationDeskContext.cs ========== 

using System;
using System.Collections.Generic;
using Microsoft.EntityFrameworkCore;
using RailwayInformationDesk.Models;

namespace RailwayInformationDesk.Data;

public partial class RailwayInformationDeskContext : DbContext
{
    public RailwayInformationDeskContext()
    {
    }

    public RailwayInformationDeskContext(DbContextOptions<RailwayInformationDeskContext> options)
        : base(options)
    {
    }

    public virtual DbSet<ActualSchedule> ActualSchedules { get; set; }

    public virtual DbSet<Route> Routes { get; set; }

    public virtual DbSet<ScheduleTemplate> ScheduleTemplates { get; set; }

    public virtual DbSet<ScheduleTemplateStop> ScheduleTemplateStops { get; set; }

    public virtual DbSet<Station> Stations { get; set; }

    public virtual DbSet<TrainType> TrainTypes { get; set; }

    public virtual DbSet<TripInstance> TripInstances { get; set; }

    public virtual DbSet<User> Users { get; set; }

    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
#warning To protect potentially sensitive information in your connection string, you should move it out of source code. You can avoid scaffolding the connection string by using the Name= syntax to read it from configuration - see https://go.microsoft.com/fwlink/?linkid=2131148. For more guidance on storing connection strings, see https://go.microsoft.com/fwlink/?LinkId=723263.
        => optionsBuilder.UseSqlServer("Server=localhost;Database=RailwayInformationDesk;Trusted_Connection=True;TrustServerCertificate=True;");

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        modelBuilder.Entity<ActualSchedule>(entity =>
        {
            entity.HasKey(e => e.Id).HasName("PK__ActualSc__3214EC0714EB8683");

            entity.ToTable("ActualSchedule");

            entity.Property(e => e.ActualPlatform).HasMaxLength(20);

            entity.HasOne(d => d.Stop).WithMany(p => p.ActualSchedules)
                .HasForeignKey(d => d.StopId)
                .OnDelete(DeleteBehavior.ClientSetNull)
                .HasConstraintName("FK_ActualSchedule_Stop");

            entity.HasOne(d => d.TripInstance).WithMany(p => p.ActualSchedules)
                .HasForeignKey(d => d.TripInstanceId)
                .HasConstraintName("FK_ActualSchedule_TripInstance");
        });

        modelBuilder.Entity<Route>(entity =>
        {
            entity.HasKey(e => e.Id).HasName("PK__Routes__3214EC07C4BC7C34");

            entity.Property(e => e.Name).HasMaxLength(200);

            entity.HasOne(d => d.ArrivalStation).WithMany(p => p.RouteArrivalStations)
                .HasForeignKey(d => d.ArrivalStationId)
                .OnDelete(DeleteBehavior.ClientSetNull)
                .HasConstraintName("FK_Routes_ArrivalStation");

            entity.HasOne(d => d.DepartureStation).WithMany(p => p.RouteDepartureStations)
                .HasForeignKey(d => d.DepartureStationId)
                .OnDelete(DeleteBehavior.ClientSetNull)
                .HasConstraintName("FK_Routes_DepartureStation");
        });

        modelBuilder.Entity<ScheduleTemplate>(entity =>
        {
            entity.HasKey(e => e.Id).HasName("PK__Schedule__3214EC074D80B873");

            entity.Property(e => e.DaysOfWeek).HasMaxLength(7);
            entity.Property(e => e.IsActive).HasDefaultValue(true);

            entity.HasOne(d => d.Route).WithMany(p => p.ScheduleTemplates)
                .HasForeignKey(d => d.RouteId)
                .OnDelete(DeleteBehavior.ClientSetNull)
                .HasConstraintName("FK_ScheduleTemplates_Route");

            entity.HasOne(d => d.TrainType).WithMany(p => p.ScheduleTemplates)
                .HasForeignKey(d => d.TrainTypeId)
                .OnDelete(DeleteBehavior.ClientSetNull)
                .HasConstraintName("FK_ScheduleTemplates_TrainType");
        });

        modelBuilder.Entity<ScheduleTemplateStop>(entity =>
        {
            entity.HasKey(e => e.Id).HasName("PK__Schedule__3214EC078330C5C0");

            entity.HasIndex(e => new { e.TemplateId, e.StopOrder }, "UQ_TemplateStops_Template_StopOrder").IsUnique();

            entity.Property(e => e.Platform).HasMaxLength(20);

            entity.HasOne(d => d.Station).WithMany(p => p.ScheduleTemplateStops)
                .HasForeignKey(d => d.StationId)
                .OnDelete(DeleteBehavior.ClientSetNull)
                .HasConstraintName("FK_TemplateStops_Station");

            entity.HasOne(d => d.Template).WithMany(p => p.ScheduleTemplateStops)
                .HasForeignKey(d => d.TemplateId)
                .HasConstraintName("FK_TemplateStops_Template");
        });

        modelBuilder.Entity<Station>(entity =>
        {
            entity.HasKey(e => e.Id).HasName("PK__Stations__3214EC0798D4E516");

            entity.HasIndex(e => e.Name, "UQ__Stations__737584F684790B9C").IsUnique();

            entity.Property(e => e.City).HasMaxLength(100);
            entity.Property(e => e.Name).HasMaxLength(100);
            entity.Property(e => e.Region).HasMaxLength(100);
        });

        modelBuilder.Entity<TrainType>(entity =>
        {
            entity.HasKey(e => e.Id).HasName("PK__TrainTyp__3214EC07DB7CEB2D");

            entity.HasIndex(e => e.Name, "UQ__TrainTyp__737584F622384B0B").IsUnique();

            entity.Property(e => e.Name).HasMaxLength(100);
        });

        modelBuilder.Entity<TripInstance>(entity =>
        {
            entity.HasKey(e => e.Id).HasName("PK__TripInst__3214EC0769E5F99D");

            entity.HasIndex(e => new { e.TemplateId, e.TripDate }, "UQ_TripInstances_Template_Date").IsUnique();

            entity.HasOne(d => d.Template).WithMany(p => p.TripInstances)
                .HasForeignKey(d => d.TemplateId)
                .OnDelete(DeleteBehavior.ClientSetNull)
                .HasConstraintName("FK_TripInstances_Template");
        });

        modelBuilder.Entity<User>(entity =>
        {
            entity.HasKey(e => e.Id).HasName("PK__Users__3214EC075A950D5E");

            entity.HasIndex(e => e.Login, "UQ__Users__5E55825BA090AE71").IsUnique();

            entity.Property(e => e.FullName)
                .HasMaxLength(150)
                .HasDefaultValue("");
            entity.Property(e => e.Login).HasMaxLength(50);
            entity.Property(e => e.PasswordHash).HasMaxLength(100);
            entity.Property(e => e.Role).HasMaxLength(30);

            entity.HasOne(d => d.Station).WithMany(p => p.Users)
                .HasForeignKey(d => d.StationId)
                .HasConstraintName("FK_Users_Station");
        });

        OnModelCreatingPartial(modelBuilder);
    }

    partial void OnModelCreatingPartial(ModelBuilder modelBuilder);
}



========== FILE: .\RailwayInformationDesk\Models\ActualSchedule.cs ========== 

using System;
using System.Collections.Generic;

namespace RailwayInformationDesk.Models;

public partial class ActualSchedule
{
    public int Id { get; set; }

    public int TripInstanceId { get; set; }

    public int StopId { get; set; }

    public DateTime? ActualArrivalTime { get; set; }

    public DateTime? ActualDepartureTime { get; set; }

    public string? ActualPlatform { get; set; }

    public int? DelayMinutes { get; set; }

    public virtual ScheduleTemplateStop Stop { get; set; } = null!;

    public virtual TripInstance TripInstance { get; set; } = null!;
}



========== FILE: .\RailwayInformationDesk\Models\Route.cs ========== 

using System;
using System.Collections.Generic;

namespace RailwayInformationDesk.Models;

public partial class Route
{
    public int Id { get; set; }

    public string Name { get; set; } = null!;

    public int DepartureStationId { get; set; }

    public int ArrivalStationId { get; set; }

    public virtual Station ArrivalStation { get; set; } = null!;

    public virtual Station DepartureStation { get; set; } = null!;

    public virtual ICollection<ScheduleTemplate> ScheduleTemplates { get; set; } = new List<ScheduleTemplate>();
}



========== FILE: .\RailwayInformationDesk\Models\ScheduleTemplate.cs ========== 

using System;
using System.Collections.Generic;

namespace RailwayInformationDesk.Models;

public partial class ScheduleTemplate
{
    public int Id { get; set; }

    public int RouteId { get; set; }

    public int TrainTypeId { get; set; }

    public bool IsActive { get; set; }

    public string? DaysOfWeek { get; set; }

    public virtual Route Route { get; set; } = null!;

    public virtual ICollection<ScheduleTemplateStop> ScheduleTemplateStops { get; set; } = new List<ScheduleTemplateStop>();

    public virtual TrainType TrainType { get; set; } = null!;

    public virtual ICollection<TripInstance> TripInstances { get; set; } = new List<TripInstance>();
}



========== FILE: .\RailwayInformationDesk\Models\ScheduleTemplateStop.cs ========== 

using System;
using System.Collections.Generic;

namespace RailwayInformationDesk.Models;

public partial class ScheduleTemplateStop
{
    public int Id { get; set; }

    public int TemplateId { get; set; }

    public int StationId { get; set; }

    public int StopOrder { get; set; }

    public TimeOnly? ArrivalTime { get; set; }

    public TimeOnly? DepartureTime { get; set; }

    public string? Platform { get; set; }

    public virtual ICollection<ActualSchedule> ActualSchedules { get; set; } = new List<ActualSchedule>();

    public virtual Station Station { get; set; } = null!;

    public virtual ScheduleTemplate Template { get; set; } = null!;
}



========== FILE: .\RailwayInformationDesk\Models\Station.cs ========== 

using System;
using System.Collections.Generic;

namespace RailwayInformationDesk.Models;

public partial class Station
{
    public int Id { get; set; }

    public string Name { get; set; } = null!;

    public string Region { get; set; } = null!;

    public string City { get; set; } = null!;

    public virtual ICollection<Route> RouteArrivalStations { get; set; } = new List<Route>();

    public virtual ICollection<Route> RouteDepartureStations { get; set; } = new List<Route>();

    public virtual ICollection<ScheduleTemplateStop> ScheduleTemplateStops { get; set; } = new List<ScheduleTemplateStop>();

    public virtual ICollection<User> Users { get; set; } = new List<User>();
}



========== FILE: .\RailwayInformationDesk\Models\TrainType.cs ========== 

using System;
using System.Collections.Generic;

namespace RailwayInformationDesk.Models;

public partial class TrainType
{
    public int Id { get; set; }

    public string Name { get; set; } = null!;

    public virtual ICollection<ScheduleTemplate> ScheduleTemplates { get; set; } = new List<ScheduleTemplate>();
}



========== FILE: .\RailwayInformationDesk\Models\TripInstance.cs ========== 

using System;
using System.Collections.Generic;

namespace RailwayInformationDesk.Models;

public partial class TripInstance
{
    public int Id { get; set; }

    public int TemplateId { get; set; }

    public DateOnly TripDate { get; set; }

    public virtual ICollection<ActualSchedule> ActualSchedules { get; set; } = new List<ActualSchedule>();

    public virtual ScheduleTemplate Template { get; set; } = null!;
}



========== FILE: .\RailwayInformationDesk\Models\User.cs ========== 

using System;
using System.Collections.Generic;

namespace RailwayInformationDesk.Models;

public partial class User
{
    public int Id { get; set; }

    public string Login { get; set; } = null!;

    public string PasswordHash { get; set; } = null!;

    public string Role { get; set; } = null!;

    public int? StationId { get; set; }

    public string FullName { get; set; } = null!;

    public virtual Station? Station { get; set; }
}



========== FILE: .\RailwayInformationDesk\Services\AuthService.cs ========== 

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace RailwayInformationDesk.Services
{
    internal class AuthService
    {
    }
}



========== FILE: .\RailwayInformationDesk\Views\AdminWindow.xaml ========== 

<!-- Views/AdminWindow.xaml -->
<Window
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        xmlns:av="http://schemas.microsoft.com/expression/blend/2008" xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" mc:Ignorable="av" x:Class="RailwayInformationDesk.Views.AdminWindow"
        Title="Администрирование" Height="750" Width="1100"
        WindowStartupLocation="CenterScreen">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <TextBox x:Name="SearchBox"
                 materialDesign:HintAssist.Hint="Поиск по таблице..."
                 Style="{StaticResource MaterialDesignTextBox}"
                 Margin="10"
                 TextChanged="SearchBox_TextChanged"/>

        <TabControl x:Name="MainTabControl" Grid.Row="2" Margin="10">
            <!-- Станции -->
            <TabItem Header="Станции">
                <DataGrid x:Name="StationsGrid"
                          AutoGenerateColumns="False"
                          CanUserAddRows="True"
                          CanUserDeleteRows="True"
                          PreviewKeyDown="DataGrid_PreviewKeyDown"
                          ItemsSource="{Binding Stations}">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="ID" Binding="{Binding Id}" IsReadOnly="True"/>
                        <DataGridTextColumn Header="Название" Binding="{Binding Name}" Width="*"/>
                        <DataGridTextColumn Header="Город" Binding="{Binding City}" Width="*"/>
                        <DataGridTextColumn Header="Регион" Binding="{Binding Region}" Width="*"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>

            <!-- Маршруты -->
            <TabItem Header="Маршруты">
                <DataGrid x:Name="RoutesGrid"
                          AutoGenerateColumns="False"
                          CanUserAddRows="True"
                          CanUserDeleteRows="True"
                          PreviewKeyDown="DataGrid_PreviewKeyDown"
                          ItemsSource="{Binding Routes}">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="ID" Binding="{Binding Id}" IsReadOnly="True"/>
                        <DataGridTextColumn Header="Название" Binding="{Binding Name}" Width="*"/>
                        <DataGridTemplateColumn Header="Откуда" Width="*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding DepartureStationId, ConverterParameter=Station, Converter={StaticResource IdToNameConverter}}" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                            <DataGridTemplateColumn.CellEditingTemplate>
                                <DataTemplate>
                                    <ComboBox ItemsSource="{Binding DataContext.Stations, RelativeSource={RelativeSource AncestorType={x:Type Window}}}"
                                              DisplayMemberPath="Name"
                                              SelectedValuePath="Id"
                                              SelectedValue="{Binding DepartureStationId, UpdateSourceTrigger=PropertyChanged}"
                                              Style="{StaticResource MaterialDesignComboBox}"
                                              SelectionChanged="DepartureOrArrivalStation_SelectionChanged"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellEditingTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTemplateColumn Header="Куда" Width="*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding ArrivalStationId, ConverterParameter=Station, Converter={StaticResource IdToNameConverter}}" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                            <DataGridTemplateColumn.CellEditingTemplate>
                                <DataTemplate>
                                    <ComboBox ItemsSource="{Binding DataContext.Stations, RelativeSource={RelativeSource AncestorType={x:Type Window}}}"
                                              DisplayMemberPath="Name"
                                              SelectedValuePath="Id"
                                              SelectedValue="{Binding ArrivalStationId, UpdateSourceTrigger=PropertyChanged}"
                                              Style="{StaticResource MaterialDesignComboBox}"
                                              SelectionChanged="DepartureOrArrivalStation_SelectionChanged"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellEditingTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>

            <!-- Типы поездов -->
            <TabItem Header="Типы поездов">
                <DataGrid x:Name="TrainTypesGrid"
                          AutoGenerateColumns="False"
                          CanUserAddRows="True"
                          CanUserDeleteRows="True"
                          PreviewKeyDown="DataGrid_PreviewKeyDown"
                          ItemsSource="{Binding TrainTypes}">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="ID" Binding="{Binding Id}" IsReadOnly="True"/>
                        <DataGridTextColumn Header="Название" Binding="{Binding Name}" Width="*"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>

            <!-- Расписание (ранее "Шаблоны расписаний") -->
            <TabItem Header="Расписание">
                <DataGrid x:Name="TemplatesGrid"
                          AutoGenerateColumns="False"
                          CanUserAddRows="True"
                          CanUserDeleteRows="True"
                          PreviewKeyDown="DataGrid_PreviewKeyDown"
                          MouseDoubleClick="TemplatesGrid_MouseDoubleClick"
                          ItemsSource="{Binding Templates}">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="ID" Binding="{Binding Id}" IsReadOnly="True"/>
                        <DataGridTemplateColumn Header="Маршрут" Width="2*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding RouteId, ConverterParameter=Route, Converter={StaticResource IdToNameConverter}}" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                            <DataGridTemplateColumn.CellEditingTemplate>
                                <DataTemplate>
                                    <ComboBox ItemsSource="{Binding DataContext.Routes, RelativeSource={RelativeSource AncestorType={x:Type Window}}}"
                                              DisplayMemberPath="Name"
                                              SelectedValuePath="Id"
                                              SelectedValue="{Binding RouteId, UpdateSourceTrigger=PropertyChanged}"
                                              Style="{StaticResource MaterialDesignComboBox}"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellEditingTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTemplateColumn Header="Тип поезда" Width="*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding TrainTypeId, ConverterParameter=TrainType, Converter={StaticResource IdToNameConverter}}" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                            <DataGridTemplateColumn.CellEditingTemplate>
                                <DataTemplate>
                                    <ComboBox ItemsSource="{Binding DataContext.TrainTypes, RelativeSource={RelativeSource AncestorType={x:Type Window}}}"
                                              DisplayMemberPath="Name"
                                              SelectedValuePath="Id"
                                              SelectedValue="{Binding TrainTypeId, UpdateSourceTrigger=PropertyChanged}"
                                              Style="{StaticResource MaterialDesignComboBox}"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellEditingTemplate>
                        </DataGridTemplateColumn>
                        <DataGridCheckBoxColumn Header="Активен" Binding="{Binding IsActive}" Width="Auto"/>
                        <DataGridTextColumn Header="Дни недели (напр. 1010100)" Binding="{Binding DaysOfWeek}" Width="*"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>

            <!-- Экземпляры рейсов -->
            <TabItem Header="Экземпляры рейсов">
                <DataGrid x:Name="TripInstancesGrid"
                          AutoGenerateColumns="False"
                          CanUserAddRows="True"
                          CanUserDeleteRows="True"
                          PreviewKeyDown="DataGrid_PreviewKeyDown"
                          ItemsSource="{Binding TripInstances}">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="ID" Binding="{Binding Id}" IsReadOnly="True"/>
                        <DataGridTemplateColumn Header="Шаблон" Width="2*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding TemplateId, ConverterParameter=Template, Converter={StaticResource IdToNameConverter}}" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                            <DataGridTemplateColumn.CellEditingTemplate>
                                <DataTemplate>
                                    <ComboBox ItemsSource="{Binding DataContext.Templates, RelativeSource={RelativeSource AncestorType={x:Type Window}}}"
                                              DisplayMemberPath="Route.Name"
                                              SelectedValuePath="Id"
                                              SelectedValue="{Binding TemplateId, UpdateSourceTrigger=PropertyChanged}"
                                              Style="{StaticResource MaterialDesignComboBox}"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellEditingTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTextColumn Header="Дата" Binding="{Binding TripDate}" Width="*"/>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>

            <!-- Пользователи -->
            <TabItem Header="Пользователи">
                <DataGrid x:Name="UsersGrid"
                          AutoGenerateColumns="False"
                          CanUserAddRows="True"
                          CanUserDeleteRows="True"
                          PreviewKeyDown="DataGrid_PreviewKeyDown"
                          ItemsSource="{Binding Users}"
                          AddingNewItem="UsersGrid_AddingNewItem">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="ID" Binding="{Binding Id}" IsReadOnly="True"/>
                        <DataGridTextColumn Header="Логин" Binding="{Binding Login}" Width="0.5*"/>
                        <DataGridTextColumn Header="ФИО" Binding="{Binding FullName}" Width="1.5*"/>
                        <DataGridTextColumn Header="Пароль" Binding="{Binding PasswordHash}" Width="*"/>
                        <DataGridTemplateColumn Header="Роль" Width="*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Role}" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                            <DataGridTemplateColumn.CellEditingTemplate>
                                <DataTemplate>
                                    <ComboBox ItemsSource="{Binding DataContext.Roles, RelativeSource={RelativeSource AncestorType={x:Type Window}}}"
                                              SelectedItem="{Binding Role, UpdateSourceTrigger=PropertyChanged}"
                                              Style="{StaticResource MaterialDesignComboBox}"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellEditingTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTemplateColumn Header="Станция" Width="2*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding StationId, ConverterParameter=Station, Converter={StaticResource IdToNameConverter}}" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                            <DataGridTemplateColumn.CellEditingTemplate>
                                <DataTemplate>
                                    <ComboBox ItemsSource="{Binding DataContext.Stations, RelativeSource={RelativeSource AncestorType={x:Type Window}}}"
                                              DisplayMemberPath="Name"
                                              SelectedValuePath="Id"
                                              SelectedValue="{Binding StationId, UpdateSourceTrigger=PropertyChanged}"
                                              Style="{StaticResource MaterialDesignComboBox}"
                                              IsEnabled="{Binding Role, Converter={StaticResource RoleToStationEnabledConverter}}"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellEditingTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </TabItem>
        </TabControl>

        <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Right" Margin="10">
            <Button Content="Сохранить" Click="SaveButton_Click" Style="{StaticResource MaterialDesignRaisedButton}"/>
        
        <Button Content="Выход"
            Click="ExitButton_Click"
            Style="{StaticResource MaterialDesignRaisedButton}"
            MinWidth="50" Margin="10 0"/>
        </StackPanel>
    </Grid>
</Window>


========== FILE: .\RailwayInformationDesk\Views\AdminWindow.xaml.cs ========== 

// Views/AdminWindow.xaml.cs
using Microsoft.EntityFrameworkCore;
using RailwayInformationDesk.Converters;
using RailwayInformationDesk.Data;
using RailwayInformationDesk.Models;
using System.Collections.ObjectModel;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Input;

namespace RailwayInformationDesk.Views;

public partial class AdminWindow : Window
{
    private readonly RailwayInformationDeskContext _context = new();

    public ObservableCollection<Station> Stations { get; } = [];
    public ObservableCollection<Route> Routes { get; } = [];
    public ObservableCollection<TrainType> TrainTypes { get; } = [];
    public ObservableCollection<ScheduleTemplate> Templates { get; } = [];
    public ObservableCollection<ScheduleTemplateStop> TemplateStops { get; } = [];
    public ObservableCollection<TripInstance> TripInstances { get; } = [];
    public ObservableCollection<User> Users { get; } = [];

    private readonly HashSet<int> _existingTemplateIds = new();

    private List<Station> _allStations = [];
    private List<Route> _allRoutes = [];
    private List<TrainType> _allTrainTypes = [];
    private List<ScheduleTemplate> _allTemplates = [];
    private List<ScheduleTemplateStop> _allTemplateStops = [];
    private List<TripInstance> _allTripInstances = [];
    private List<User> _allUsers = [];

    public List<string> Roles { get; } = ["Администратор", "Дежурный"];

    public AdminWindow()
    {
        InitializeComponent();
        DataContext = this;
        _ = LoadDataAsync();
        UsersGrid.AddingNewItem += UsersGrid_AddingNewItem;
    }

    private void UsersGrid_AddingNewItem(object sender, AddingNewItemEventArgs e)
    {
        e.NewItem = new User
        {
            Login = "",
            PasswordHash = "",
            FullName = "",
            Role = "Администратор",
            StationId = null
        };
    }

    private async Task LoadDataAsync()
    {
        try
        {
            var stations = await _context.Stations.OrderBy(s => s.Id).ToListAsync();
            Stations.Clear();
            foreach (var stat in stations) 
                Stations.Add(stat);
            _allStations = [.. stations];

            var trainTypes = await _context.TrainTypes.OrderBy(t => t.Id).ToListAsync();
            TrainTypes.Clear();
            foreach(var trainType in trainTypes)
                TrainTypes.Add(trainType);
            _allTrainTypes = [.. trainTypes];

            var routes = await _context.Routes
                .Include(r => r.DepartureStation)
                .Include(r => r.ArrivalStation)
                .OrderBy(r => r.Id)
                .ToListAsync();
            Routes.Clear(); 
            foreach (var route in routes)
                Routes.Add(route);
            _allRoutes = [.. routes];

            var templates = await _context.ScheduleTemplates
                .Include(t => t.Route)
                .Include(t => t.TrainType)
                .OrderBy(t => t.Id)
                .ToListAsync();
            Templates.Clear();
            foreach (var template in templates)
                Templates.Add(template);
            _allTemplates = [.. templates];

            _existingTemplateIds.Clear();
            _existingTemplateIds.UnionWith(templates.Select(t => t.Id));

            var templateStops = await _context.ScheduleTemplateStops
                .Include(ts => ts.Station)
                .Include(ts => ts.Template)
                .OrderBy(ts => ts.Id)
                .ToListAsync();
            TemplateStops.Clear();   
            foreach (var templateStop in templateStops)
                TemplateStops.Add(templateStop);
            _allTemplateStops = [.. templateStops];

            var tripInstances = await _context.TripInstances
                .Include(ti => ti.Template)
                .ThenInclude(t => t.Route)
                .OrderBy(ti => ti.Id)
                .ToListAsync();
            TripInstances.Clear(); 
            foreach(var tripInstance in tripInstances)
                TripInstances.Add(tripInstance);
            _allTripInstances = [.. tripInstances];

            var users = await _context.Users
                .Include(u => u.Station)
                .OrderBy(u => u.Id)
                .ToListAsync();
            Users.Clear(); 
            foreach( var user in users)
                Users.Add(user);
            _allUsers = [.. users];

            // Обновляем конвертеры
            IdToNameConverter.Stations = Stations;
            IdToNameConverter.Routes = Routes;
            IdToNameConverter.TrainTypes = TrainTypes;
            IdToNameConverter.Templates = Templates;
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Ошибка загрузки данных:\n{ex.Message}", "Ошибка", MessageBoxButton.OK, MessageBoxImage.Error);
        }
    }

    private void DepartureOrArrivalStation_SelectionChanged(object sender, SelectionChangedEventArgs e)
    {
        if (sender is not ComboBox comboBox || comboBox.DataContext is not Route route) return;

        var dep = Stations.FirstOrDefault(s => s.Id == route.DepartureStationId);
        var arr = Stations.FirstOrDefault(s => s.Id == route.ArrivalStationId);
        if (dep != null && arr != null)
        {
            string name = $"{dep.Name} > {arr.Name}";
            if (route.Name == name) return;
            if (MessageBox.Show($"Обновить название маршрута на:\n\"{name}\"?", "Предложение", MessageBoxButton.YesNo) == MessageBoxResult.Yes)
                route.Name = name;
        }
    }

    private void DataGrid_PreviewKeyDown(object sender, KeyEventArgs e)
    {
        if (e.Key != Key.Delete || sender is not DataGrid dg || dg.SelectedItem == null) return;

        if (MessageBox.Show("Удалить запись?", "Подтверждение", MessageBoxButton.YesNo, MessageBoxImage.Warning) != MessageBoxResult.Yes)
        {
            e.Handled = true;
            return;
        }

        switch (dg.Name)
        {
            case "StationsGrid":
                if (dg.SelectedItem is Station s)
                {
                    if (Routes.Any(r => r.DepartureStationId == s.Id || r.ArrivalStationId == s.Id) ||
                        Users.Any(u => u.StationId == s.Id) ||
                        TemplateStops.Any(ts => ts.StationId == s.Id))
                    {
                        MessageBox.Show("Нельзя удалить: станция используется.", "Ошибка", MessageBoxButton.OK, MessageBoxImage.Error);
                        e.Handled = true;
                        return;
                    }
                    if (Stations.Contains(s))
                    {
                        Stations.Remove(s);
                        _context.Stations.Remove(s);
                    }
                }
                break;
            case "RoutesGrid":
                if (dg.SelectedItem is Route r)
                {
                    if (Templates.Any(t => t.RouteId == r.Id))
                    {
                        MessageBox.Show("Нельзя удалить маршрут: есть связанные шаблоны.", "Ошибка", MessageBoxButton.OK, MessageBoxImage.Error);
                        e.Handled = true;
                        return;
                    }
                    Routes.Remove(r);
                    _context.Routes.Remove(r);
                }
                break;
            case "TrainTypesGrid":
                if (dg.SelectedItem is TrainType tt)
                {
                    if (Templates.Any(t => t.TrainTypeId == tt.Id))
                    {
                        MessageBox.Show("Нельзя удалить тип: есть связанные шаблоны.", "Ошибка", MessageBoxButton.OK, MessageBoxImage.Error);
                        e.Handled = true;
                        return;
                    }
                    TrainTypes.Remove(tt);
                    _context.TrainTypes.Remove(tt);
                }
                break;
            case "TemplatesGrid":
                if (dg.SelectedItem is ScheduleTemplate t)
                {
                    var stopsToRemove = TemplateStops.Where(ts => ts.TemplateId == t.Id).ToList();
                    foreach (var stop in stopsToRemove)
                    {
                        TemplateStops.Remove(stop);
                        _context.ScheduleTemplateStops.Remove(stop);
                    }
                    var tripsToRemove = TripInstances.Where(ti => ti.TemplateId == t.Id).ToList();
                    foreach (var trip in tripsToRemove)
                    {
                        TripInstances.Remove(trip);
                        _context.TripInstances.Remove(trip);
                    }
                    Templates.Remove(t);
                    _context.ScheduleTemplates.Remove(t);
                }
                break;
            case "TemplateStopsGrid":
                if (dg.SelectedItem is ScheduleTemplateStop ts)
                {
                    TemplateStops.Remove(ts);
                    _context.ScheduleTemplateStops.Remove(ts);
                }
                break;
            case "TripInstancesGrid":
                if (dg.SelectedItem is TripInstance ti)
                {
                    TripInstances.Remove(ti);
                    _context.TripInstances.Remove(ti);
                }
                break;
            case "UsersGrid":
                if (dg.SelectedItem is User u)
                {
                    Users.Remove(u);
                    _context.Users.Remove(u);
                }
                break;
        }
        e.Handled = true;
    }

    private string GetCurrentTabHeader() =>
        MainTabControl.SelectedItem is TabItem item ? item.Header.ToString()! : "";

    private void SearchBox_TextChanged(object sender, TextChangedEventArgs e)
    {
        string filter = SearchBox.Text.Trim().ToLower();
        switch (GetCurrentTabHeader())
        {
            case "Станции": Filter(filter, Stations, _allStations, s => s.Name.Contains(filter) || s.City.Contains(filter) || s.Region.Contains(filter)); break;
            case "Маршруты": Filter(filter, Routes, _allRoutes, r => r.Name.Contains(filter) || GetStationName(r.DepartureStationId).Contains(filter) || GetStationName(r.ArrivalStationId).Contains(filter)); break;
            case "Типы поездов": Filter(filter, TrainTypes, _allTrainTypes, t => t.Name.Contains(filter)); break;
            case "Шаблоны расписаний": Filter(filter, Templates, _allTemplates, t => GetRouteName(t.RouteId).Contains(filter) || GetTrainTypeName(t.TrainTypeId).Contains(filter)); break;
            case "Остановки в шаблонах": Filter(filter, TemplateStops, _allTemplateStops, ts => GetStationName(ts.StationId).Contains(filter) || GetTemplateName(ts.TemplateId).Contains(filter)); break;
            case "Экземпляры рейсов": Filter(filter, TripInstances, _allTripInstances, ti => GetTemplateName(ti.TemplateId).Contains(filter) || ti.TripDate.ToString().Contains(filter)); break;
            case "Пользователи": Filter(filter, Users, _allUsers, u => u.Login.Contains(filter) || u.FullName.Contains(filter) || u.Role.Contains(filter) || GetStationName(u.StationId).Contains(filter)); break;
        }
    }

    private string GetStationName(int? id) => Stations.FirstOrDefault(s => s.Id == id)?.Name ?? "";
    private string GetRouteName(int id) => Routes.FirstOrDefault(r => r.Id == id)?.Name ?? "";
    private string GetTrainTypeName(int id) => TrainTypes.FirstOrDefault(t => t.Id == id)?.Name ?? "";
    private string GetTemplateName(int id) => Templates.FirstOrDefault(t => t.Id == id)?.Route.Name ?? "";

    private void Filter<T>(string filter, ObservableCollection<T> target, List<T> source, Func<T, bool> predicate)
    {
        target.Clear();
        var items = string.IsNullOrEmpty(filter) ? source : source.Where(predicate).ToList();
        foreach (var item in items) target.Add(item);
    }

    private async void SaveButton_Click(object sender, RoutedEventArgs e)
    {
        try
        {
            ValidateUsers();
            ValidateTemplates();
            ValidateTripInstances();

            // Этап 1: Добавляем новые сущности (без остановок!)
            AddNewEntitiesStage();
            await _context.SaveChangesAsync(); // < шаблоны получают Id

            // Этап 2: Определяем, какие шаблоны были созданы в этом сеансе
            var newlySavedTemplates = Templates
                .Where(t => t.Id > 0 && !_existingTemplateIds.Contains(t.Id))
                .ToList();

            foreach (var template in newlySavedTemplates)
            {
                // Создаём базовые остановки ТОЛЬКО для новых шаблонов
                var route = Routes.FirstOrDefault(r => r.Id == template.RouteId);
                if (route == null)
                    throw new InvalidOperationException($"Маршрут для шаблона ID={template.Id} не найден.");

                var firstStop = new ScheduleTemplateStop
                {
                    TemplateId = template.Id,
                    StationId = route.DepartureStationId,
                    StopOrder = 0,
                    DepartureTime = new TimeOnly(8, 0),
                    Platform = "1"
                };

                var lastStop = new ScheduleTemplateStop
                {
                    TemplateId = template.Id,
                    StationId = route.ArrivalStationId,
                    StopOrder = 1,
                    ArrivalTime = new TimeOnly(20, 0),
                    Platform = "1"
                };

                TemplateStops.Add(firstStop);
                TemplateStops.Add(lastStop);
                _context.ScheduleTemplateStops.Add(firstStop);
                _context.ScheduleTemplateStops.Add(lastStop);
            }

            if (newlySavedTemplates.Any())
            {
                await _context.SaveChangesAsync(); 
            }

            RefreshAllLists();
            MessageBox.Show("Данные успешно сохранены!", "Успех", MessageBoxButton.OK, MessageBoxImage.Information);
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Ошибка при сохранении:\n{ex.Message}", "Ошибка", MessageBoxButton.OK, MessageBoxImage.Error);
        }
    }

    private bool IsTripAllowedOnDate(ScheduleTemplate template, DateOnly tripDate)
    {
        if (string.IsNullOrEmpty(template.DaysOfWeek) || template.DaysOfWeek.Length != 7)
            return false;

        // DayOfWeek в .NET: Monday=1, Tuesday=2, ..., Sunday=0
        int dayIndex = tripDate.DayOfWeek switch
        {
            DayOfWeek.Monday => 0,
            DayOfWeek.Tuesday => 1,
            DayOfWeek.Wednesday => 2,
            DayOfWeek.Thursday => 3,
            DayOfWeek.Friday => 4,
            DayOfWeek.Saturday => 5,
            DayOfWeek.Sunday => 6,
            _ => throw new ArgumentOutOfRangeException(nameof(tripDate))
        };

        return template.DaysOfWeek[dayIndex] == '1';
    }
    private void ExitButton_Click(object sender, RoutedEventArgs e)
    {
        try
        {
            new LoginWindow().Show();
            this.Close();
        }
        catch { }
    }

    private void ValidateUsers()
    {
        foreach (var u in Users)
        {
            if (string.IsNullOrWhiteSpace(u.Login)) throw new InvalidOperationException("Логин не может быть пустым.");
            if (string.IsNullOrWhiteSpace(u.PasswordHash)) throw new InvalidOperationException($"Пароль не указан для '{u.Login}'.");
            if (string.IsNullOrWhiteSpace(u.FullName)) throw new InvalidOperationException($"ФИО не указано для '{u.Login}'.");
            if (u.Role != "Администратор" && u.Role != "Дежурный")
                throw new InvalidOperationException($"Недопустимая роль: '{u.Role}'.");
            if (u.Role == "Дежурный" && !u.StationId.HasValue)
                throw new InvalidOperationException($"У дежурного '{u.Login}' не указана станция.");
            if (u.Role == "Администратор") u.StationId = null;
        }
    }

    private void AddNewEntitiesStage()
    {
        if (Stations.Any(s => s.Id == 0)) _context.Stations.AddRange(Stations.Where(s => s.Id == 0));
        if (Routes.Any(r => r.Id == 0)) _context.Routes.AddRange(Routes.Where(r => r.Id == 0));
        if (TrainTypes.Any(t => t.Id == 0)) _context.TrainTypes.AddRange(TrainTypes.Where(t => t.Id == 0));
        if (Templates.Any(t => t.Id == 0)) _context.ScheduleTemplates.AddRange(Templates.Where(t => t.Id == 0));
        if (TripInstances.Any(ti => ti.Id == 0)) _context.TripInstances.AddRange(TripInstances.Where(ti => ti.Id == 0));
        if (Users.Any(u => u.Id == 0)) _context.Users.AddRange(Users.Where(u => u.Id == 0));
    }

    private void RefreshAllLists()
    {
        _allStations = [.. Stations];
        _allRoutes = [.. Routes];
        _allTrainTypes = [.. TrainTypes];
        _allTemplates = [.. Templates];
        _allTemplateStops = [.. TemplateStops];
        _allTripInstances = [.. TripInstances];
        _allUsers = [.. Users];
    }

    private void ValidateTemplates()
    {
        foreach (var template in Templates)
        {
            var days = template.DaysOfWeek?.Trim();

            if (string.IsNullOrEmpty(days))
                throw new InvalidOperationException($"У шаблона (ID={template.Id}) не указаны дни недели.");

            if (days.Length != 7)
                throw new InvalidOperationException($"Дни недели для шаблона (ID={template.Id}) должны содержать ровно 7 символов (например: 1100101).");

            if (!days.All(c => c == '0' || c == '1'))
                throw new InvalidOperationException($"Дни недели для шаблона (ID={template.Id}) могут содержать только '0' и '1'.");
        }
    }

    private void ValidateTripInstances()
    {
        foreach (var trip in TripInstances.Where(ti => ti.Id == 0))
        {
            var template = Templates.FirstOrDefault(t => t.Id == trip.TemplateId);
            if (template == null)
                throw new InvalidOperationException($"Шаблон для рейса не найден (TemplateId={trip.TemplateId}).");

            if (!IsTripAllowedOnDate(template, trip.TripDate))
            {
                var dayName = trip.TripDate.DayOfWeek switch
                {
                    DayOfWeek.Monday => "понедельник",
                    DayOfWeek.Tuesday => "вторник",
                    DayOfWeek.Wednesday => "среда",
                    DayOfWeek.Thursday => "четверг",
                    DayOfWeek.Friday => "пятница",
                    DayOfWeek.Saturday => "суббота",
                    DayOfWeek.Sunday => "воскресенье",
                    _ => "неизвестный день"
                };
                throw new InvalidOperationException(
                    $"Нельзя создать рейс на {trip.TripDate:d} ({dayName}) — поезд по шаблону \"{template.Route.Name}\" не ходит в этот день.");
            }
        }
    }

    private void TemplatesGrid_MouseDoubleClick(object sender, MouseButtonEventArgs e)
    {
        if (TemplatesGrid.SelectedItem is not ScheduleTemplate template) return;

        if (template.Id == 0) return;

        var stopsWindow = new TemplateStopsWindow(template, _context);
        stopsWindow.ShowDialog();

        // После закрытия — перезагрузим остановки, если нужно
        _ = LoadDataAsync(); // или частичная перезагрузка только TemplateStops
    }
}


========== FILE: .\RailwayInformationDesk\Views\DispatcherWindow.xaml ========== 

<!-- Views/DispatcherWindow.xaml -->
<Window x:Class="RailwayInformationDesk.Views.DispatcherWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        Title="Дежурный по станции" Height="650" Width="1200"
        WindowStartupLocation="CenterScreen">
    <Grid Margin="15">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <TextBlock Text="Поезда на ближайшие 12 часов"
                   Style="{StaticResource MaterialDesignHeadline5TextBlock}"
                   Margin="0,0,0,10"/>

        <DataGrid x:Name="IncomingTrainsGrid"
                  Grid.Row="1"
                  AutoGenerateColumns="False"
                  CanUserAddRows="False"
                  IsReadOnly="False">
            <DataGrid.Columns>
                <DataGridTextColumn Header="Маршрут" Binding="{Binding Stop.Template.Route.Name}" Width="2*"/>
                <DataGridTextColumn Header="Тип" Binding="{Binding Stop.Template.TrainType.Name}" Width="1*"/>
                <DataGridTextColumn Header="План. прибытие" Binding="{Binding PlannedArrivalTime, StringFormat='HH:mm'}" Width="1.3*"/>
                <DataGridTextColumn Header="План. отправление" Binding="{Binding PlannedDepartureTime, StringFormat='HH:mm'}" Width="1.3*"/>
                <DataGridTemplateColumn Header="Платф. факт" Width="*">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBox Text="{Binding ActualPlatform, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource MaterialDesignTextBox}" />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
                <!-- Факт. прибытие -->
                <DataGridTemplateColumn Header="Факт. прибытие" Width="1.3*">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding ActualSchedule.ActualArrivalTime, StringFormat='HH:mm'}" />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                    <DataGridTemplateColumn.CellEditingTemplate>
                        <DataTemplate>
                            <TextBox Text="{Binding ActualSchedule.ActualArrivalTime, 
                                    UpdateSourceTrigger=PropertyChanged}"
                    TextChanged="TimeTextBox_TextChanged"
                     materialDesign:HintAssist.Hint="чч:мм"
                     MaxLength="5"
                     Style="{StaticResource MaterialDesignTextBox}"
                     Background="Transparent"
                     BorderThickness="0"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellEditingTemplate>
                </DataGridTemplateColumn>

                <!-- Факт. отправление -->
                <DataGridTemplateColumn Header="Факт. отправление" Width="1.3*">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding ActualSchedule.ActualDepartureTime, StringFormat='HH:mm'}" />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                    <DataGridTemplateColumn.CellEditingTemplate>
                        <DataTemplate>
                            <TextBox Text="{Binding ActualSchedule.ActualDepartureTime, 
                                    UpdateSourceTrigger=PropertyChanged}"
                     TextChanged="TimeTextBox_TextChanged"
                     materialDesign:HintAssist.Hint="чч:мм"
                     MaxLength="5"
                     Style="{StaticResource MaterialDesignTextBox}"
                     Background="Transparent"
                     BorderThickness="0"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellEditingTemplate>
                </DataGridTemplateColumn>
            </DataGrid.Columns>
        </DataGrid>

        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,10,0,0">
            <Button Content="Сохранить фактические данные"
        Click="SaveButton_Click"
        Style="{StaticResource MaterialDesignRaisedButton}"
        MinWidth="75"/>
            <Button Content="Выход"
                    Margin="10 0 0 0 "
        Click="ExitButton_Click"
        Style="{StaticResource MaterialDesignRaisedButton}"
        MinWidth="50"/>
        </StackPanel>
    </Grid>
</Window>


========== FILE: .\RailwayInformationDesk\Views\DispatcherWindow.xaml.cs ========== 

// Views/DispatcherWindow.xaml.cs
using Microsoft.EntityFrameworkCore;
using RailwayInformationDesk.Data;
using RailwayInformationDesk.Models;
using System.Windows;
using System.Windows.Controls;

namespace RailwayInformationDesk.Views;

public partial class DispatcherWindow : Window
{
    private readonly RailwayInformationDeskContext _context = new();
    private readonly Station _station;

    public DispatcherWindow(Station station)
    {
        InitializeComponent();
        _station = station;
        Title += $" — {_station.Name}";
        LoadIncomingTrains();
    }

    private async void LoadIncomingTrains()
    {
        var now = DateTime.Now;
        var end = now.AddHours(12);
        var dateToday = DateOnly.FromDateTime(now);

        // Загружаем остановки шаблонов для текущей станции
        var stops = await _context.ScheduleTemplateStops
            .Where(ts => ts.StationId == _station.Id && ts.ArrivalTime.HasValue)
            .Include(ts => ts.Template)
                .ThenInclude(t => t.Route)
            .Include(ts => ts.Template)
                .ThenInclude(t => t.TrainType)
            .ToListAsync();

        var viewModels = new List<DispatcherViewModel>();

        foreach (var stop in stops)
        {
            // Находим экземпляр рейса на сегодня
            var tripInstance = await _context.TripInstances
                .FirstOrDefaultAsync(ti => ti.TemplateId == stop.TemplateId && ti.TripDate == dateToday);

            if (tripInstance == null) continue;

            // Планируемое время прибытия
            var plannedArrival = new DateTime(dateToday.Year, dateToday.Month, dateToday.Day,
                stop.ArrivalTime!.Value.Hour, stop.ArrivalTime!.Value.Minute, 0);

            if (plannedArrival < now)
                plannedArrival = plannedArrival.AddDays(1);

            if (plannedArrival > end) continue;

            // Создаём ViewModel БЕЗ загрузки из ActualSchedule
            viewModels.Add(new DispatcherViewModel
            {
                Stop = stop,
                TripInstance = tripInstance,
                ActualSchedule = new ActualSchedule
                {
                    StopId = stop.Id,
                    TripInstanceId = tripInstance.Id,
                    TripInstance = tripInstance,
                    // Id = 0 > будет добавлен в БД только при сохранении с данными
                },
                PlannedArrivalTime = plannedArrival,
                PlannedDepartureTime = stop.DepartureTime.HasValue
                    ? plannedArrival.Date.Add(stop.DepartureTime.Value.ToTimeSpan())
                    : (DateTime?)null
            });
        }

        IncomingTrainsGrid.ItemsSource = viewModels.OrderBy(vm => vm.PlannedArrivalTime).ToList();
    }

    private async void SaveButton_Click(object sender, RoutedEventArgs e)
    {
        try
        {
            var viewModels = (List<DispatcherViewModel>)IncomingTrainsGrid.ItemsSource;

            foreach (var vm in viewModels)
            {
                // Проверяем, были ли введены фактические данные
                bool hasData = !string.IsNullOrWhiteSpace(vm.ActualPlatform) ||
                               vm.ActualSchedule.ActualArrivalTime.HasValue ||
                               vm.ActualSchedule.ActualDepartureTime.HasValue;

                if (hasData)
                {
                    if (vm.PlannedDepartureTime.HasValue && vm.ActualSchedule.ActualDepartureTime.HasValue)
                    {
                        var planned = vm.PlannedDepartureTime.Value;
                        var actual = vm.ActualSchedule.ActualDepartureTime.Value;

                        if (actual > planned)
                        {
                            // Задержка = разница в минутах
                            vm.ActualSchedule.DelayMinutes = (int)(actual - planned).TotalMinutes;
                        }
                        else
                        {
                            // Поезд отправился вовремя или раньше > задержка = 0
                            vm.ActualSchedule.DelayMinutes = 0;
                        }
                    }
                    else
                    {
                        // Если нет данных — сбрасываем задержку
                        vm.ActualSchedule.DelayMinutes = null;
                    }

                    _context.ActualSchedules.Add(vm.ActualSchedule); 
                }
            }

            await _context.SaveChangesAsync();
            MessageBox.Show("Фактические данные сохранены!", "Успех", MessageBoxButton.OK, MessageBoxImage.Information);
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Ошибка:\n{ex.Message}", "Ошибка", MessageBoxButton.OK, MessageBoxImage.Error);
        }
    }

    protected override void OnClosed(EventArgs e)
    {
        _context?.Dispose();
        base.OnClosed(e);
    }

    private void TimeTextBox_TextChanged(object sender, TextChangedEventArgs e)
    {
    }

    private void ExitButton_Click(object sender, RoutedEventArgs e)
    {
        try
        {
            new LoginWindow().Show();
            this.Close();
        }
        catch { }
    }
}

public class DispatcherViewModel
{
    public ScheduleTemplateStop Stop { get; set; } = null!;
    public TripInstance TripInstance { get; set; } = null!;
    public ActualSchedule ActualSchedule { get; set; } = null!;
    public DateTime PlannedArrivalTime { get; set; }
    public DateTime? PlannedDepartureTime { get; set; }

    public string? ActualPlatform
    {
        get => ActualSchedule.ActualPlatform;
        set => ActualSchedule.ActualPlatform = value;
    }
}




========== FILE: .\RailwayInformationDesk\Views\LoginWindow.xaml ========== 

<!-- Views/LoginWindow.xaml -->
<Window x:Class="RailwayInformationDesk.Views.LoginWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        mc:Ignorable="d"
        Title="Вход в систему" Height="380" Width="420"
        WindowStartupLocation="CenterScreen"
        ResizeMode="NoResize">
    <Grid Margin="30">
        <StackPanel VerticalAlignment="Center">
            <TextBlock Text="Железнодорожная информационная система"
                       Style="{StaticResource MaterialDesignHeadline5TextBlock}"
                       HorizontalAlignment="Center"
                       Margin="0,0,0,30"
                       TextWrapping="Wrap"
                       TextAlignment="Center"/>

            <TextBox x:Name="LoginBox"
                     materialDesign:HintAssist.Hint="Логин"
                     Style="{StaticResource MaterialDesignTextBox}"
                     Margin="0,0,0,16"
                     MaxLength="50"/>

            <PasswordBox x:Name="PasswordBox"
                         materialDesign:HintAssist.Hint="Пароль"
                         Style="{StaticResource MaterialDesignPasswordBox}"
                         Margin="0,0,0,24"
                         MaxLength="100"/>

            <Button Content="Войти"
                    Margin="0 0 0 10"
                    Click="LoginButton_Click"
                    Style="{StaticResource MaterialDesignRaisedButton}"
                    HorizontalAlignment="Stretch"
                    Height="42"/>

            <Button Content="Войти как пользователь"
        Click="LoginUserButton_Click"
        Style="{StaticResource MaterialDesignRaisedButton}"
        HorizontalAlignment="Stretch"
        Height="42"/>
        </StackPanel>
    </Grid>
</Window>


========== FILE: .\RailwayInformationDesk\Views\LoginWindow.xaml.cs ========== 

// Views/LoginWindow.xaml.cs
using Microsoft.EntityFrameworkCore;
using RailwayInformationDesk.Data;
using RailwayInformationDesk.Views;
using System.Windows;

namespace RailwayInformationDesk.Views;

public partial class LoginWindow : Window
{
    private readonly RailwayInformationDeskContext _context;

    public LoginWindow()
    {
        InitializeComponent();
        _context = new RailwayInformationDeskContext();
    }

    private async void LoginButton_Click(object sender, RoutedEventArgs e)
    {
        try
        {
            string login = LoginBox.Text?.Trim() ?? "";
            string password = PasswordBox.Password ?? "";

            if (string.IsNullOrEmpty(login) || string.IsNullOrEmpty(password))
            {
                MessageBox.Show("Введите логин и пароль", "Ошибка", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            var user = await _context.Users
                .Include(u => u.Station)
                .FirstOrDefaultAsync(u => u.Login == login);

            if (user == null)
            {
                MessageBox.Show("Пользователь не найден", "Ошибка", MessageBoxButton.OK, MessageBoxImage.Error);
                return;
            }

            // Сравнение без хэширования (пароль в открытом виде)
            if (password != user.PasswordHash)
            {
                MessageBox.Show("Неверный пароль", "Ошибка", MessageBoxButton.OK, MessageBoxImage.Error);
                return;
            }

            // Открытие нужного окна в зависимости от роли
            switch (user.Role)
            {
                case "Администратор":
                    new AdminWindow().Show();
                    break;
                case "Дежурный":
                    if (user.Station == null)
                    {
                        MessageBox.Show("У дежурного не указана станция", "Ошибка", MessageBoxButton.OK, MessageBoxImage.Error);
                        return;
                    }
                    new DispatcherWindow(user.Station).Show();
                    break;
                case "Пользователь":
                    new UserSearchWindow().Show();
                    break;
                default:
                    MessageBox.Show("Неизвестная роль", "Ошибка", MessageBoxButton.OK, MessageBoxImage.Error);
                    return;
            }

            this.Close();
        }
        catch { }
    }

        private void LoginUserButton_Click(object sender, RoutedEventArgs e)
    {
        try
        {
            new UserSearchWindow().Show();
            this.Close();
        }
        catch { }
    }

    
}


========== FILE: .\RailwayInformationDesk\Views\TemplateStopsWindow.xaml ========== 

<!-- Views/TemplateStopsWindow.xaml -->
<Window x:Class="RailwayInformationDesk.Views.TemplateStopsWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        Title="Остановки расписания" Height="600" Width="900"
        WindowStartupLocation="CenterOwner">
    <Grid Margin="15">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <TextBlock Text="{Binding Template.Route.Name}" Style="{StaticResource MaterialDesignHeadline5TextBlock}" Margin="0,0,0,10"/>

        <DataGrid x:Name="StopsGrid"
                  Grid.Row="1"
                  AutoGenerateColumns="False"
                  CanUserAddRows="True"
                  CanUserDeleteRows="True"
                  ItemsSource="{Binding Stops}"
                  PreviewKeyDown="StopsGrid_PreviewKeyDown">
            <DataGrid.Columns>
                <DataGridTextColumn Header="Порядок" Binding="{Binding StopOrder}" Width="100"/>
                <DataGridTemplateColumn Header="Станция" Width="*">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding StationId, Converter={StaticResource IdToNameConverter}, ConverterParameter=Station}" />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                    <DataGridTemplateColumn.CellEditingTemplate>
                        <DataTemplate>
                            <ComboBox ItemsSource="{Binding DataContext.AllStations, RelativeSource={RelativeSource AncestorType=Window}}"
                                      DisplayMemberPath="Name"
                                      SelectedValuePath="Id"
                                      SelectedValue="{Binding StationId, UpdateSourceTrigger=PropertyChanged}"
                                      Style="{StaticResource MaterialDesignComboBox}"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellEditingTemplate>
                </DataGridTemplateColumn>
                <!-- Прибытие -->
                <DataGridTemplateColumn Header="Прибытие (чч:мм)" Width="*">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding ArrivalTime, StringFormat='HH:mm'}" />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                    <DataGridTemplateColumn.CellEditingTemplate>
                        <DataTemplate>
                            <TextBox Text="{Binding ArrivalTime, UpdateSourceTrigger=PropertyChanged}"
                     TextChanged="TimeTextBox_TextChanged"
                     MaxLength="5"
                     Style="{StaticResource MaterialDesignTextBox}" />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellEditingTemplate>
                </DataGridTemplateColumn>

                <!-- Отправление -->
                <DataGridTemplateColumn Header="Отправление (чч:мм)" Width="*">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding DepartureTime, StringFormat='HH:mm'}" />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                    <DataGridTemplateColumn.CellEditingTemplate>
                        <DataTemplate>
                            <TextBox Text="{Binding DepartureTime, UpdateSourceTrigger=PropertyChanged}"
                     TextChanged="TimeTextBox_TextChanged"
                     MaxLength="5"
                     Style="{StaticResource MaterialDesignTextBox}" />
                        </DataTemplate>
                    </DataGridTemplateColumn.CellEditingTemplate>
                </DataGridTemplateColumn>
                <DataGridTextColumn Header="Платформа" Binding="{Binding Platform}" Width="*"/>
            </DataGrid.Columns>
        </DataGrid>

        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,10,0,0">
            <Button Content="Сохранить" Click="SaveButton_Click" Style="{StaticResource MaterialDesignRaisedButton}" MinWidth="120"/>
        </StackPanel>
    </Grid>
</Window>


========== FILE: .\RailwayInformationDesk\Views\TemplateStopsWindow.xaml.cs ========== 

// Views/TemplateStopsWindow.xaml.cs
using Microsoft.EntityFrameworkCore;
using RailwayInformationDesk.Converters;
using RailwayInformationDesk.Data;
using RailwayInformationDesk.Models;
using System.Collections.ObjectModel;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Input;

namespace RailwayInformationDesk.Views;

public partial class TemplateStopsWindow : Window
{
    private readonly ScheduleTemplate _template;
    private readonly RailwayInformationDeskContext _context;
    public ObservableCollection<ScheduleTemplateStop> Stops { get; } = [];
    public List<Station> AllStations { get; private set; } = [];

    // Кэшируем ID первой и последней станции из маршрута
    private int _departureStationId;
    private int _arrivalStationId;

    public TemplateStopsWindow(ScheduleTemplate template, RailwayInformationDeskContext context)
    {
        InitializeComponent();
        _template = template;
        _context = context;
        DataContext = this;

        // Получаем станции маршрута
        _departureStationId = template.Route.DepartureStationId;
        _arrivalStationId = template.Route.ArrivalStationId;

        Title = $"Остановки расписания: {template.Route.Name}";
        _ = LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        var stops = await _context.ScheduleTemplateStops
            .Where(s => s.TemplateId == _template.Id)
            .OrderBy(s => s.StopOrder)
            .ToListAsync();

        // Если остановок нет — создаём начальную и конечную
        if (!stops.Any())
        {
            stops.Add(new ScheduleTemplateStop
            {
                StationId = _departureStationId,
                StopOrder = 0,
                DepartureTime = new TimeOnly(8, 0),
                Platform = "1"
            });
            stops.Add(new ScheduleTemplateStop
            {
                StationId = _arrivalStationId,
                StopOrder = 1,
                ArrivalTime = new TimeOnly(18, 0),
                Platform = "1"
            });
        }

        Stops.Clear();
        foreach (var s in stops) Stops.Add(s);

        AllStations = await _context.Stations.OrderBy(s => s.Name).ToListAsync();
        IdToNameConverter.Stations = new(AllStations);
    }

    private void StopsGrid_PreviewKeyDown(object sender, KeyEventArgs e)
    {
        if (e.Key == Key.Delete && sender is DataGrid dg && dg.SelectedItem is ScheduleTemplateStop stop)
        {
            // Запрещаем удаление первой и последней
            if (IsTerminalStop(stop))
            {
                MessageBox.Show("Нельзя удалить первую или последнюю остановку.", "Ошибка", MessageBoxButton.OK, MessageBoxImage.Warning);
                e.Handled = true;
                return;
            }

            if (MessageBox.Show("Удалить остановку?", "Подтверждение", MessageBoxButton.YesNo) == MessageBoxResult.Yes)
            {
                Stops.Remove(stop);
                _context.ScheduleTemplateStops.Remove(stop);
                e.Handled = true;
            }
        }
    }

    private bool IsTerminalStop(ScheduleTemplateStop stop)
    {
        return (stop.StationId == _departureStationId && stop.StopOrder == Stops.Min(s => s.StopOrder)) ||
               (stop.StationId == _arrivalStationId && stop.StopOrder == Stops.Max(s => s.StopOrder));
    }

    private void StopsGrid_BeginningEdit(object sender, DataGridBeginningEditEventArgs e)
    {
        if (e.Row.Item is not ScheduleTemplateStop stop) return;

        var isFirst = stop.StationId == _departureStationId && stop.StopOrder == Stops.Min(s => s.StopOrder);
        var isLast = stop.StationId == _arrivalStationId && stop.StopOrder == Stops.Max(s => s.StopOrder);

        if (isFirst || isLast)
        {
            // Определяем, какую колонку пытаются редактировать
            if (e.Column.Header?.ToString() == "Станция" || e.Column.Header?.ToString() == "Порядок")
            {
                MessageBox.Show("Первая и последняя остановки определяются маршрутом и не подлежат редактированию.",
                    "Ошибка", MessageBoxButton.OK, MessageBoxImage.Warning);
                e.Cancel = true;
            }
        }
    }

    private void StopsGrid_AddingNewItem(object sender, AddingNewItemEventArgs e)
    {
        if (Stops.Count < 2)
        {
            MessageBox.Show("Сначала сохраните базовые остановки (начало и конец).", "Ошибка", MessageBoxButton.OK, MessageBoxImage.Warning);
            return;
        }

        // Находим последнюю остановку (максимальный StopOrder)
        var lastStop = Stops.OrderByDescending(s => s.StopOrder).First();

        // Новая остановка получает порядок = текущий максимум
        int newOrder = lastStop.StopOrder;

        // Сдвигаем последнюю на +1
        lastStop.StopOrder++;

        // Создаём новую остановку **перед** бывшей последней
        e.NewItem = new ScheduleTemplateStop
        {
            TemplateId = _template.Id,
            StationId = AllStations
                .FirstOrDefault(s => s.Id != _departureStationId && s.Id != _arrivalStationId)?.Id
                ?? AllStations.First().Id,
            StopOrder = newOrder,
            Platform = "1"
        };
    }

    private async void SaveButton_Click(object sender, RoutedEventArgs e)
    {
        try
        {
            ValidateStops();
            // Валидация: проверка уникальности StopOrder и границ
            var orders = Stops.Select(s => s.StopOrder).ToList();
            var minOrder = orders.Min();
            var maxOrder = orders.Max();

            // Первая и последняя должны быть фиксированы
            var first = Stops.First(s => s.StopOrder == minOrder);
            var last = Stops.First(s => s.StopOrder == maxOrder);

            if (first.StationId != _departureStationId)
                throw new InvalidOperationException("Первая остановка должна совпадать со станцией отправления маршрута.");
            if (last.StationId != _arrivalStationId)
                throw new InvalidOperationException("Последняя остановка должна совпадать со станцией назначения маршрута.");

            // Проверка дубликатов
            if (orders.Count != orders.Distinct().Count())
                throw new InvalidOperationException("Порядок остановок не должен повторяться.");

            // Проверка диапазона: все промежуточные должны быть строго между min и max
            foreach (var stop in Stops)
            {
                if (stop.StopOrder <= minOrder && stop.StationId != _departureStationId)
                    throw new InvalidOperationException("Промежуточная остановка не может иметь порядок ? первой.");
                if (stop.StopOrder >= maxOrder && stop.StationId != _arrivalStationId)
                    throw new InvalidOperationException("Промежуточная остановка не может иметь порядок ?последней.");
            }

            // Присваиваем TemplateId новым
            foreach (var stop in Stops.Where(s => s.Id == 0))
                stop.TemplateId = _template.Id;

            // Синхронизация с БД
            var existingInDb = await _context.ScheduleTemplateStops
                .Where(s => s.TemplateId == _template.Id)
                .ToListAsync();

            foreach (var dbStop in existingInDb)
            {
                if (!Stops.Contains(dbStop))
                    _context.ScheduleTemplateStops.Remove(dbStop);
            }

            var newStops = Stops.Where(s => s.Id == 0).ToList();
            if (newStops.Any())
                _context.ScheduleTemplateStops.AddRange(newStops);

            await _context.SaveChangesAsync();

            MessageBox.Show("Остановки успешно сохранены!", "Успех", MessageBoxButton.OK, MessageBoxImage.Information);
            DialogResult = true;
            Close();
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Ошибка:\n{ex.Message}", "Ошибка", MessageBoxButton.OK, MessageBoxImage.Error);
        }
    }

    private void TimeTextBox_TextChanged(object sender, TextChangedEventArgs e)
    {
    }

    private void ValidateStops()
    {
        if (Stops.Count < 2)
            throw new InvalidOperationException("Должны быть хотя бы две остановки.");

        var ordered = Stops.OrderBy(s => s.StopOrder).ToList();
        var first = ordered.First();
        var last = ordered.Last();

        if (first.StationId != _departureStationId)
            throw new InvalidOperationException("Первая остановка должна совпадать со станцией отправления маршрута.");
        if (last.StationId != _arrivalStationId)
            throw new InvalidOperationException("Последняя остановка должна совпадать со станцией назначения маршрута.");
        if (first.StopOrder != 0)
            throw new InvalidOperationException("Порядок первой остановки должен быть 0.");
    }
}


========== FILE: .\RailwayInformationDesk\Views\UserSearchWindow.xaml ========== 

<!-- Views/UserSearchWindow.xaml -->
<Window x:Class="RailwayInformationDesk.Views.UserSearchWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        Title="Поиск поездов" Height="650" Width="900"
        WindowStartupLocation="CenterScreen">
    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <ComboBox x:Name="RegionCombo"
                  materialDesign:HintAssist.Hint="Выберите регион"
                  Style="{StaticResource MaterialDesignComboBox}"
                  SelectionChanged="RegionCombo_SelectionChanged"
                  Margin="0,0,0,15"/>

        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,15">
            <ComboBox x:Name="FromStation" materialDesign:HintAssist.Hint="Откуда" Width="220" Margin="0,0,15,0"/>
            <ComboBox x:Name="ToStation" materialDesign:HintAssist.Hint="Куда" Width="220"/>
        </StackPanel>

        <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,0,0,15">
            <Button Content="Найти поезда" Click="SearchButton_Click" Style="{StaticResource MaterialDesignRaisedButton}" Margin="0,0,15,0"/>
            <CheckBox x:Name="ShowPastTrips" Content="Показать ушедшие поезда" Checked="TogglePastTrips" Unchecked="TogglePastTrips"/>
        </StackPanel>

        <DataGrid x:Name="TripsGrid" Grid.Row="3" AutoGenerateColumns="False" IsReadOnly="True">
            <DataGrid.Columns>
                <DataGridTextColumn Header="Маршрут" Binding="{Binding Template.Route.Name}" Width="2*"/>
                <DataGridTextColumn Header="Тип" Binding="{Binding Template.TrainType.Name}" Width="*"/>
                <DataGridTextColumn Header="Отправление" Binding="{Binding DepartureDisplay}" Width="2*"/>
                <DataGridTextColumn Header="Прибытие" Binding="{Binding ArrivalDisplay}" Width="2*"/>
                <DataGridTextColumn Header="Платформа" Binding="{Binding Platform}" Width="2*"/>
            </DataGrid.Columns>
        </DataGrid>
    </Grid>
</Window>


========== FILE: .\RailwayInformationDesk\Views\UserSearchWindow.xaml.cs ========== 

// Views/UserSearchWindow.xaml.cs
using Microsoft.EntityFrameworkCore;
using RailwayInformationDesk.Data;
using RailwayInformationDesk.Models;
using System.Windows;
using System.Windows.Controls;

namespace RailwayInformationDesk.Views;

public partial class UserSearchWindow : Window
{
    private readonly RailwayInformationDeskContext _context = new();
    private List<Station> _stationsInRegion = [];
    private Station? _from, _to;

    public UserSearchWindow()
    {
        InitializeComponent();
        LoadRegions();
    }

    private async void LoadRegions()
    {
        var regions = await _context.Stations.Select(s => s.Region).Distinct().OrderBy(r => r).ToListAsync();
        RegionCombo.ItemsSource = regions;
    }

    private async void RegionCombo_SelectionChanged(object sender, SelectionChangedEventArgs e)
    {
        if (RegionCombo.SelectedItem is not string region) return;
        _stationsInRegion = await _context.Stations.Where(s => s.Region == region).OrderBy(s => s.Name).ToListAsync();
        FromStation.ItemsSource = _stationsInRegion;
        ToStation.ItemsSource = _stationsInRegion;
        FromStation.DisplayMemberPath = "Name";
        ToStation.DisplayMemberPath = "Name";
    }

    private async void SearchButton_Click(object sender, RoutedEventArgs e)
    {
        if (FromStation.SelectedItem is not Station from || ToStation.SelectedItem is not Station to)
        {
            MessageBox.Show("Выберите станции.", "Ошибка", MessageBoxButton.OK, MessageBoxImage.Warning);
            return;
        }
        _from = from;
        _to = to;
        await LoadTrips();
    }

    private async Task LoadTrips()
    {
        var today = DateOnly.FromDateTime(DateTime.Today);
        var templates = await _context.ScheduleTemplates
            .Where(t => t.Route.DepartureStationId == _from!.Id && t.Route.ArrivalStationId == _to!.Id)
            .Include(t => t.Route)
            .Include(t => t.TrainType)
            .Include(t => t.ScheduleTemplateStops)
            .ToListAsync();

        var viewModels = new List<UserTripViewModel>();

        foreach (var template in templates)
        {
            var tripInstance = await _context.TripInstances
                .FirstOrDefaultAsync(ti => ti.TemplateId == template.Id && ti.TripDate == today);
            if (tripInstance == null) continue;

            var departureStop = template.ScheduleTemplateStops
                .FirstOrDefault(s => s.StationId == _from!.Id);
            var arrivalStop = template.ScheduleTemplateStops
                .FirstOrDefault(s => s.StationId == _to!.Id);

            if (departureStop == null || arrivalStop == null) continue;

            viewModels.Add(new UserTripViewModel
            {
                Template = template,
                TripDate = today,
                DepartureTime = departureStop.DepartureTime,
                ArrivalTime = arrivalStop.ArrivalTime,
                Platform = departureStop.Platform ?? "—"
            });
        }

        TripsGrid.ItemsSource = viewModels;
    }

    private void TogglePastTrips(object sender, RoutedEventArgs e) { /* уже фильтруется по времени */ }
}

public class UserTripViewModel
{
    public ScheduleTemplate Template { get; set; } = null!;
    public DateOnly TripDate { get; set; }
    public TimeOnly? DepartureTime { get; set; }
    public TimeOnly? ArrivalTime { get; set; }
    public string Platform { get; set; } = "—";

    public string DepartureDisplay => DepartureTime.HasValue ? $"{TripDate:dd.MM} {DepartureTime:HH:mm}" : "—";
    public string ArrivalDisplay => ArrivalTime.HasValue ? $"{TripDate:dd.MM} {ArrivalTime:HH:mm}" : "—";
}


========== FILE: .\RailwayInformationDesk\App.xaml ========== 

<Application x:Class="RailwayInformationDesk.App"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             StartupUri="Views/LoginWindow.xaml">
    <Application.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <materialDesign:BundledTheme BaseTheme="Light" PrimaryColor="Blue" SecondaryColor="Lime"/>
                <ResourceDictionary Source="pack://application:,,,/MaterialDesignThemes.Wpf;component/Themes/MaterialDesign3.Defaults.xaml" />
            </ResourceDictionary.MergedDictionaries>

            <local:IdToNameConverter x:Key="IdToNameConverter" xmlns:local="clr-namespace:RailwayInformationDesk.Converters"/>
            <local:RoleToStationEnabledConverter x:Key="RoleToStationEnabledConverter" xmlns:local="clr-namespace:RailwayInformationDesk.Converters"/>
            <local:TimeInputConverter x:Key="TimeInputConverter" xmlns:local="clr-namespace:RailwayInformationDesk.Converters"/>
            <local:DateTimeToTimeStringConverter x:Key="DateTimeToTimeStringConverter" xmlns:local="clr-namespace:RailwayInformationDesk.Converters"/>

            <Style TargetType="TextBox" BasedOn="{StaticResource MaterialDesignTextBox}">
                <Setter Property="AutomationProperties.Name" Value="" />
            </Style>
            <Style TargetType="ComboBox" BasedOn="{StaticResource MaterialDesignComboBox}">
                <Setter Property="AutomationProperties.Name" Value="" />
            </Style>
            <Style TargetType="Button" BasedOn="{StaticResource MaterialDesignRaisedButton}">
                <Setter Property="AutomationProperties.Name" Value="" />
            </Style>
            <Style TargetType="DatePicker" BasedOn="{StaticResource MaterialDesignDatePicker}">
                <Setter Property="AutomationProperties.Name" Value="" />
            </Style>
        </ResourceDictionary>
    </Application.Resources>
</Application>


========== FILE: .\RailwayInformationDesk\App.xaml.cs ========== 

using System.Configuration;
using System.Data;
using System.Windows;

namespace RailwayInformationDesk
{
    /// <summary>
    /// Interaction logic for App.xaml
    /// </summary>
    public partial class App : Application
    {
    }

}



========== FILE: .\RailwayInformationDesk\DateTimeToTimeStringConverter.cs ========== 

// Converters/DateTimeToTimeStringConverter.cs
using System.Globalization;
using System.Windows.Data;

namespace RailwayInformationDesk.Converters;

public class DateTimeToTimeStringConverter : IValueConverter
{
    public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
    {
        return value is DateTime dt ? dt.ToString("HH:mm") : "";
    }

    public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
    {
        if (value is not string text) return null;

        // Разрешаем частичный ввод: "9", "91", "912" и т.д.
        var digits = new string(text.Where(char.IsDigit).ToArray());

        if (digits.Length == 0) return null;

        // Формируем временную строку в формате HH:mm
        string timeStr = digits.Length switch
        {
            1 => $"{digits[0]}",
            2 => $"{digits[0..2]}",
            3 => $"{digits[0..2]}:{digits[2]}",
            >= 4 => $"{digits[0..2]}:{digits.Substring(2, 2)}",
            _ => ""
        };

        // Ограничиваем значения
        if (TimeOnly.TryParseExact(timeStr, "HH:mm", culture, DateTimeStyles.None, out var time))
        {
            // Возвращаем DateTime с фиктивной датой (она будет заменена позже)
            return new DateTime(1900, 1, 1, time.Hour, time.Minute, 0);
        }

        return null;
    }
}


========== FILE: .\RailwayInformationDesk\IdToNameConverter.cs ========== 

using RailwayInformationDesk.Models;
using System.Collections.ObjectModel;
using System.Globalization;
using System.Windows.Data;

namespace RailwayInformationDesk.Converters;

public class IdToNameConverter : IValueConverter
{
    public static ObservableCollection<Station> Stations { get; set; } = [];
    public static ObservableCollection<Route> Routes { get; set; } = [];
    public static ObservableCollection<TrainType> TrainTypes { get; set; } = [];
    public static ObservableCollection<ScheduleTemplate> Templates { get; set; } = [];

    public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
    {
        if (value is not int id) return "—";

        return parameter?.ToString() switch
        {
            "Station" => Stations.FirstOrDefault(s => s.Id == id)?.Name ?? "—",
            "Route" => Routes.FirstOrDefault(r => r.Id == id)?.Name ?? "—",
            "TrainType" => TrainTypes.FirstOrDefault(t => t.Id == id)?.Name ?? "—",
            "Template" => Templates.FirstOrDefault(t => t.Id == id)?.Route.Name ?? "—",
            _ => "—"
        };
    }

    public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        => throw new NotImplementedException();
}


========== FILE: .\RailwayInformationDesk\RailwayInformationDesk.csproj ========== 

<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <OutputType>WinExe</OutputType>
    <TargetFramework>net8.0-windows</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
    <UseWPF>true</UseWPF>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="MaterialDesignColors" Version="5.3.0" />
    <PackageReference Include="MaterialDesignThemes" Version="5.3.0" />
    <PackageReference Include="Microsoft.EntityFrameworkCore" Version="9.0.10" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.SqlServer" Version="9.0.10" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="9.0.10">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
  </ItemGroup>

</Project>



========== FILE: .\RailwayInformationDesk\RoleToStationEnabledConverter.cs ========== 

// Converters/RoleToStationEnabledConverter.cs
using System.Globalization;
using System.Windows.Data;

namespace RailwayInformationDesk.Converters;

public class RoleToStationEnabledConverter : IValueConverter
{
    public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
    {
        return value is string role && role == "Дежурный";
    }

    public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
    {
        throw new NotImplementedException();
    }
}


========== FILE: .\RailwayInformationDesk\TimeInputConverter.cs ========== 

// Converters/TimeInputConverter.cs
using System.Globalization;
using System.Windows.Data;

namespace RailwayInformationDesk.Converters;

public class TimeInputConverter : IValueConverter
{
    public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
    {
        // Из модели в UI: формат "HH:mm"
        if (value is DateTime dateTime)
            return dateTime.ToString("HH:mm");
        if (value is string str && TimeOnly.TryParse(str, out var time))
            return time.ToString("HH:mm");
        return value?.ToString() ?? "";
    }

    public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
    {
        // Из UI в модель: обработка ввода
        if (value is not string input)
            return null;

        // Убираем всё, кроме цифр
        string digits = new string(input.Where(char.IsDigit).ToArray());

        // Автоматически вставляем ':' после 2 цифр
        string formatted = digits.Length switch
        {
            0 => "",
            1 => digits,
            2 => $"{digits}:",
            3 => $"{digits[0..2]}:{digits[2]}",
            4 => $"{digits[0..2]}:{digits[2..4]}",
            _ => $"{digits[0..2]}:{digits[2..4]}" // ограничиваем 4 цифрами
        };

        // Возвращаем отформатированную строку для отображения
        // Но в модель передаём только цифры (или null)
        return digits.Length >= 4 ? formatted : formatted;
    }
}


========== FILE: .\RailwayInformationDesk.sln ========== 


Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Version 17
VisualStudioVersion = 17.14.36811.4 d17.14
MinimumVisualStudioVersion = 10.0.40219.1
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "RailwayInformationDesk", "RailwayInformationDesk\RailwayInformationDesk.csproj", "{E130A893-3E8D-4779-A2B0-19A25435D2F7}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|Any CPU = Debug|Any CPU
		Release|Any CPU = Release|Any CPU
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{E130A893-3E8D-4779-A2B0-19A25435D2F7}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{E130A893-3E8D-4779-A2B0-19A25435D2F7}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{E130A893-3E8D-4779-A2B0-19A25435D2F7}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{E130A893-3E8D-4779-A2B0-19A25435D2F7}.Release|Any CPU.Build.0 = Release|Any CPU
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
	GlobalSection(ExtensibilityGlobals) = postSolution
		SolutionGuid = {41A2845E-FDF7-44A8-8BE4-4CE67D64FF88}
	EndGlobalSection
EndGlobal

